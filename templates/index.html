<!-- ê²½ë¡œ : templates/index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Mood2Idea</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  {% if step == 1 %}
  <script src="{{ url_for('static', filename='animation.js') }}" defer></script>
  {% endif %}
</head>
<body>
<!-- ì¢Œìš° ìƒ‰ìƒ ì¸ë””ì¼€ì´í„° (Step 2 ì´í›„ í‘œì‹œ) -->
{% if step >= 2 and step < 10 and draft.mood_color %}
  <!-- ì™¼ìª½: ì´ˆê¸° ìƒ‰ (ì›ìƒ‰, ì§„í•œ ìƒ‰ìœ¼ë¡œ í†µì¼) -->
  <div class="mood-indicator left">
    <div class="mood-indicator-orb" style="background: 
      {% if draft.mood_color == 'pink' %}#FF69B4
      {% elif draft.mood_color == 'green' %}#32CD32
      {% elif draft.mood_color == 'mint' %}#4FD1C5
      {% elif draft.mood_color == 'purple' %}#9400D3
      {% elif draft.mood_color == 'magenta' %}#C71585
      {% elif draft.mood_color == 'blue' %}#1E90FF
      {% elif draft.mood_color == 'navy' %}#1A3A52
      {% elif draft.mood_color == 'anxiety' %}#6A5ACD
      {% elif draft.mood_color == 'orange' %}#FF8C00
      {% elif draft.mood_color == 'tangerine' %}#FF6347
      {% elif draft.mood_color == 'red' %}#DC143C
      {% elif draft.mood_color == 'wine' %}#722F37
      {% elif draft.mood_color == 'black' %}#36454F
      {% elif draft.mood_color == 'panic' %}#1C1C1C
      {% elif draft.mood_color == 'shame' %}#8B7D6B
      {% elif draft.mood_color == 'embarrassed' %}#FFB6C1
      {% elif draft.mood_color == 'proud' %}#6B8E23
      {% elif draft.mood_color == 'jealousy' %}#FFB347
      {% elif draft.mood_color == 'longing' %}#FFD700
      {% elif draft.mood_color == 'grateful' %}#FFDAB9
      {% elif draft.mood_color == 'emptiness' %}#A9A9A9
      {% endif %}
    ;"></div>
    <div class="mood-indicator-label">ì²˜ìŒ<br>ê°ì •</div>
  </div>

  <!-- ì˜¤ë¥¸ìª½: í˜„ì¬ ìƒ‰ (í™œë™ í›„ ì˜…ì–´ì§) -->
  <div class="mood-indicator right">
    <div class="mood-indicator-orb" style="background: {% if draft.final_color %}{{ draft.final_color }}{% elif current_color %}{{ current_color }}{% else %}
      {% if draft.mood_color == 'pink' %}#FF69B4
      {% elif draft.mood_color == 'green' %}#32CD32
      {% elif draft.mood_color == 'mint' %}#4FD1C5
      {% elif draft.mood_color == 'purple' %}#9400D3
      {% elif draft.mood_color == 'magenta' %}#C71585
      {% elif draft.mood_color == 'blue' %}#1E90FF
      {% elif draft.mood_color == 'navy' %}#1A3A52
      {% elif draft.mood_color == 'anxiety' %}#6A5ACD
      {% elif draft.mood_color == 'orange' %}#FF8C00
      {% elif draft.mood_color == 'tangerine' %}#FF6347
      {% elif draft.mood_color == 'red' %}#DC143C
      {% elif draft.mood_color == 'wine' %}#722F37
      {% elif draft.mood_color == 'black' %}#36454F
      {% elif draft.mood_color == 'panic' %}#1C1C1C
      {% elif draft.mood_color == 'shame' %}#8B7D6B
      {% elif draft.mood_color == 'embarrassed' %}#FFB6C1
      {% elif draft.mood_color == 'proud' %}#6B8E23
      {% elif draft.mood_color == 'jealousy' %}#FFB347
      {% elif draft.mood_color == 'longing' %}#FFD700
      {% elif draft.mood_color == 'grateful' %}#FFDAB9
      {% elif draft.mood_color == 'emptiness' %}#A9A9A9
      {% endif %}
    {% endif %};"></div>
    <div class="mood-indicator-label">ì§€ê¸ˆ<br>ê°ì •</div>
  </div>
{% endif %}

<div class="container">

  {% if step == 1 %}
    <h2>ì˜¤ëŠ˜ì˜ ê°ì • ìƒ‰</h2>
    <p class="hint">ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì„ ê°€ì¥ ì˜ í‘œí˜„í•˜ëŠ” ìƒ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
    
    <form method="POST">
      <div class="color-grid">
        <label class="color-chip" data-color="pink">
          <input type="radio" name="mood_color" value="pink" {% if draft.mood_color == "pink" %}checked{% endif %} required>
          <div class="chip-visual" style="background: #FF69B4;"></div>
          <div class="chip-label">ì„¤ë ˜</div>
        </label>

        <label class="color-chip" data-color="green">
          <input type="radio" name="mood_color" value="green" {% if draft.mood_color == "green" %}checked{% endif %}>
          <div class="chip-visual" style="background: #32CD32;"></div>
          <div class="chip-label">ì¦ê±°ì›€</div>
        </label>

        <label class="color-chip" data-color="mint">
          <input type="radio" name="mood_color" value="mint" {% if draft.mood_color == "mint" %}checked{% endif %}>
          <div class="chip-visual" style="background: #4FD1C5;"></div>
          <div class="chip-label">í‰ì˜¨</div>
        </label>

        <label class="color-chip" data-color="purple">
          <input type="radio" name="mood_color" value="purple" {% if draft.mood_color == "purple" %}checked{% endif %}>
          <div class="chip-visual" style="background: #9400D3;"></div>
          <div class="chip-label">ì™¸ë¡œì›€</div>
        </label>

        <label class="color-chip" data-color="magenta">
          <input type="radio" name="mood_color" value="magenta" {% if draft.mood_color == "magenta" %}checked{% endif %}>
          <div class="chip-visual" style="background: #C71585;"></div>
          <div class="chip-label">ì„œìš´í•¨</div>
        </label>

        <label class="color-chip" data-color="blue">
          <input type="radio" name="mood_color" value="blue" {% if draft.mood_color == "blue" %}checked{% endif %}>
          <div class="chip-visual" style="background: #1E90FF;"></div>
          <div class="chip-label">ìš°ìš¸</div>
        </label>

        <label class="color-chip" data-color="navy">
          <input type="radio" name="mood_color" value="navy" {% if draft.mood_color == "navy" %}checked{% endif %}>
          <div class="chip-visual" style="background: #1A3A52;"></div>
          <div class="chip-label">ì§€ì¹¨</div>
        </label>

        <label class="color-chip" data-color="anxiety">
          <input type="radio" name="mood_color" value="anxiety" {% if draft.mood_color == "anxiety" %}checked{% endif %}>
          <div class="chip-visual" style="background: #6A5ACD;"></div>
          <div class="chip-label">ë¶ˆì•ˆ</div>
        </label>

        <label class="color-chip" data-color="orange">
          <input type="radio" name="mood_color" value="orange" {% if draft.mood_color == "orange" %}checked{% endif %}>
          <div class="chip-visual" style="background: #FF8C00;"></div>
          <div class="chip-label">ì´ˆì¡°í•¨</div>
        </label>

        <label class="color-chip" data-color="tangerine">
          <input type="radio" name="mood_color" value="tangerine" {% if draft.mood_color == "tangerine" %}checked{% endif %}>
          <div class="chip-visual" style="background: #FF6347;"></div>
          <div class="chip-label">ì„œëŸ¬ì›€</div>
        </label>

        <label class="color-chip" data-color="red">
          <input type="radio" name="mood_color" value="red" {% if draft.mood_color == "red" %}checked{% endif %}>
          <div class="chip-visual" style="background: #DC143C;"></div>
          <div class="chip-label">ë¶„ë…¸</div>
        </label>

        <label class="color-chip" data-color="wine">
          <input type="radio" name="mood_color" value="wine" {% if draft.mood_color == "wine" %}checked{% endif %}>
          <div class="chip-visual" style="background: #722F37;"></div>
          <div class="chip-label">ë‹µë‹µí•¨</div>
        </label>

        <label class="color-chip" data-color="black">
          <input type="radio" name="mood_color" value="black" {% if draft.mood_color == "black" %}checked{% endif %}>
          <div class="chip-visual" style="background: #36454F;"></div>
          <div class="chip-label">í˜¼ë€</div>
        </label>

        <label class="color-chip" data-color="panic">
          <input type="radio" name="mood_color" value="panic" {% if draft.mood_color == "panic" %}checked{% endif %}>
          <div class="chip-visual" style="background: #1C1C1C;"></div>
          <div class="chip-label">íŒ¨ë‹‰</div>
        </label>

        <label class="color-chip" data-color="shame">
          <input type="radio" name="mood_color" value="shame" {% if draft.mood_color == "shame" %}checked{% endif %}>
          <div class="chip-visual" style="background: #8B7D6B;"></div>
          <div class="chip-label">ìê´´ê°</div>
        </label>

        <label class="color-chip" data-color="embarrassed">
          <input type="radio" name="mood_color" value="embarrassed" {% if draft.mood_color == "embarrassed" %}checked{% endif %}>
          <div class="chip-visual" style="background: #FFB6C1;"></div>
          <div class="chip-label">ì°½í”¼í•¨</div>
        </label>

        <label class="color-chip" data-color="proud">
          <input type="radio" name="mood_color" value="proud" {% if draft.mood_color == "proud" %}checked{% endif %}>
          <div class="chip-visual" style="background: #6B8E23;"></div>
          <div class="chip-label">ë¿Œë“¯í•¨</div>
        </label>

        <label class="color-chip" data-color="jealousy">
          <input type="radio" name="mood_color" value="jealousy" {% if draft.mood_color == "jealousy" %}checked{% endif %}>
          <div class="chip-visual" style="background: #FFB347;"></div>
          <div class="chip-label">ì§ˆíˆ¬</div>
        </label>

        <label class="color-chip" data-color="longing">
          <input type="radio" name="mood_color" value="longing" {% if draft.mood_color == "longing" %}checked{% endif %}>
          <div class="chip-visual" style="background: #FFD700;"></div>
          <div class="chip-label">ê·¸ë¦¬ì›€</div>
        </label>

        <label class="color-chip" data-color="grateful">
          <input type="radio" name="mood_color" value="grateful" {% if draft.mood_color == "grateful" %}checked{% endif %}>
          <div class="chip-visual" style="background: #FFDAB9;"></div>
          <div class="chip-label">ê°ì‚¬í•¨</div>
        </label>

        <label class="color-chip" data-color="emptiness">
          <input type="radio" name="mood_color" value="emptiness" {% if draft.mood_color == "emptiness" %}checked{% endif %}>
          <div class="chip-visual" style="background: #A9A9A9;"></div>
          <div class="chip-label">í—ˆë¬´í•¨</div>
        </label>
      </div>

      <button type="submit" class="primary-button">ë‹¤ìŒ</button>
    </form>

  {% elif step == 2 %}
    <h2>ê°ì • í•œ ì¤„</h2>
    <p class="hint">ì§€ê¸ˆ ëŠë¼ëŠ” ê°ì •ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•´ì£¼ì„¸ìš”</p>
    <form method="POST">
      <input type="text" name="mood_text" placeholder="ì§€ê¸ˆ ê¸°ë¶„ì€?" required value="{{ draft.mood_text or '' }}">
      <button type="submit" class="primary-button">ë‹¤ìŒ</button>
    </form>

  {% elif step == 3 %}
    <h2>í‘œí˜„ ë°©ì‹</h2>
    <p class="hint">ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ê°ì •ì„ í‘œí˜„í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</p>
    
    <form method="POST">
      <div class="mode-grid">
        <label class="mode-card">
          <input type="radio" name="mode" value="write"
                 {% if (draft.mode or 'write') == 'write' %}checked{% endif %} required>
          <div class="mode-content">
            <div class="mode-icon">âœï¸</div>
            <div class="mode-title">ê¸€</div>
            <div class="mode-desc">ê¸€ë¡œ ê°ì •ì„ í’€ì–´ë‚´ìš”</div>
          </div>
        </label>

        <label class="mode-card">
          <input type="radio" name="mode" value="draw"
                 {% if draft.mode == 'draw' %}checked{% endif %}>
          <div class="mode-content">
            <div class="mode-icon">ğŸ¨</div>
            <div class="mode-title">ê·¸ë¦¼</div>
            <div class="mode-desc">ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•´ìš”</div>
          </div>
        </label>

        <label class="mode-card">
          <input type="radio" name="mode" value="music"
                 {% if draft.mode == 'music' %}checked{% endif %}>
          <div class="mode-content">
            <div class="mode-icon">ğŸµ</div>
            <div class="mode-title">ìŒì•…</div>
            <div class="mode-desc">ìŒì•…ìœ¼ë¡œ ê³µê°í•´ìš”</div>
          </div>
        </label>
      </div>

      <button type="submit" class="primary-button">ë‹¤ìŒ</button>
    </form>

  {% elif step == 4 %}
    <h2>í‘œí˜„í•˜ê¸°</h2>

    <!-- STEP4ëŠ” draw ì—…ë¡œë“œê°€ ìˆìœ¼ë‹ˆ multipart ìœ ì§€ -->
    <form method="POST" enctype="multipart/form-data">

      {% if draft.mode == "write" %}
        <textarea name="text_content" placeholder="ê°ì •ì— ëŒ€í•œ ê¸€ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”. AIì™€ ì´ì•¼ê¸° ë‚˜ëˆ„ê±°ë‚˜ ê¸€ì„ ë‹¤ë“¬ì„ ìˆ˜ë„ ìˆì–´ìš”"></textarea>

      {% elif draft.mode == "draw" %}
        <input type="file" name="image_file" accept="image/*" required>
        <p class="hint">ğŸ¨ ê·¸ë¦¼ íŒŒì¼ì„ ë°˜ë“œì‹œ ì„ íƒí•´ì£¼ì„¸ìš”</p>
        <input type="text" name="draw_note" placeholder="ê·¸ë¦¼ì— ë‹´ê¸´ ê°ì •ì´ë‚˜ ìƒê°ì„ ì ì–´ë³´ì„¸ìš” (ì„ íƒ)">

      {% elif draft.mode == "music" %}
        <!-- âœ… ìŒì•…: í‚¤ì›Œë“œë§Œ ì €ì¥ -->
        <input
          type="text"
          name="music_keywords"
          placeholder="ì˜¤ëŠ˜ì„ ëŒ€í‘œí•˜ëŠ” ìŒì•… í‚¤ì›Œë“œ (ì˜ˆ: ëª½í™˜, ë¹„ ì˜¤ëŠ” ë°¤, ë¡œíŒŒì´, ìƒˆë²½, ë¼íë§ˆë‹ˆë…¸í”„)"
          required
        >
        <p class="hint">ğŸµ í‚¤ì›Œë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ AIê°€ ìŒì•…ì„ ì¶”ì²œí•´ë“œë ¤ìš” (ìµœëŒ€ 2íšŒ)</p>
      {% endif %}

      <input type="text" name="background" placeholder="ì–´ë–¤ ìƒí™©ì—ì„œ ì´ëŸ° ê°ì •ì´ ë“¤ì—ˆë‚˜ìš”? (ì„ íƒ)">
      
      {% if draft.mode == "music" %}
        <button type="submit" class="primary-button">ğŸµ ì¶”ì²œë°›ê¸°</button>
      {% else %}
        <button type="submit" class="primary-button">ë‹¤ìŒ</button>
      {% endif %}
    </form>

  {% elif step == 5 %}
    <h2>AI ë„ì›€ ë°›ê¸°</h2>
    <p class="hint">AIëŠ” ê°ì •ì„ íŒë‹¨í•˜ì§€ ì•Šê³ , í‘œí˜„ì„ ë„ì™€ì£¼ëŠ” ì¡°ë ¥ìì˜ˆìš”.</p>

    {% if ai_limit_exceeded %}
      <div class="error-message">
        <p>âš ï¸ AIì™€ì˜ ëŒ€í™”ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”. í‘œí˜„ì„ ë” ì‘ì„±í•˜ê±°ë‚˜ ì €ì¥í•´ì£¼ì„¸ìš”.</p>
      </div>
    {% endif %}

    {% if ai_count > 0 %}
      <div class="ai-usage-badge">
        <span>AI ì‚¬ìš©: {{ ai_usage }}</span>
      </div>
    {% endif %}

    <form method="POST">
      <div class="ai-choice-grid">
        <label class="ai-choice-card">
          <input type="radio" name="ai_choice" value="save" id="ai-save" checked required>
          <div class="card-content">
            <div class="card-icon">ğŸ’¾</div>
            <div class="card-title">ê·¸ëŒ€ë¡œ ì €ì¥</div>
            <div class="card-desc">AI ì—†ì´ ë°”ë¡œ ì €ì¥í• ê²Œìš”</div>
          </div>
        </label>

        <label class="ai-choice-card {% if not can_use_ai_more %}disabled{% endif %}">
          <input type="radio" name="ai_choice" value="chat" id="ai-chat" {% if not can_use_ai_more %}disabled{% endif %} required>
          <div class="card-content">
            <div class="card-icon">ğŸ’¬</div>
            <div class="card-title">AIì™€ ëŒ€í™”</div>
            <div class="card-desc">{% if can_use_ai_more %}ì´ ë‚´ìš©ìœ¼ë¡œ ëŒ€í™”í•˜ê¸°{% else %}ì‚¬ìš© ì™„ë£Œ{% endif %}</div>
          </div>
        </label>

        <label class="ai-choice-card {% if not can_use_ai_more %}disabled{% endif %}">
          <input type="radio" name="ai_choice" value="develop" id="ai-develop" {% if not can_use_ai_more %}disabled{% endif %} required>
          <div class="card-content">
            <div class="card-icon">{% if draft.mode == "draw" %}ğŸ¨{% else %}âœ¨{% endif %}</div>
            <div class="card-title">AIì™€ ë””ë²¨ë¡­</div>
            <div class="card-desc">
              {% if can_use_ai_more %}
                {% if draft.mode == "draw" %}ì´ë¯¸ì§€ ìˆ˜ì • (DALL-E){% else %}ì´ ë‚´ìš©ì„ ë” ë‹¤ë“¬ê¸°{% endif %}
              {% else %}ì‚¬ìš© ì™„ë£Œ{% endif %}
            </div>
          </div>
        </label>
      </div>

      <!-- ë™ì  ì„¹ì…˜: AIì™€ ëŒ€í™” / AIì™€ ë””ë²¨ë¡­ ì„ íƒ ì‹œ í‘œì‹œ -->
      <div id="ai-interaction-section" style="display: none; margin-top: 24px;">
        
        {% if draft.mode == "write" %}
          <!-- ê¸€ì“°ê¸°: ì‘ì„±í•œ ë‚´ìš© -->
          <div class="preview-section">
            <div class="preview-label">ğŸ“ ì‘ì„±í•œ ë‚´ìš©</div>
            <div class="preview-content">
              {{ draft.text_content or "(ë‚´ìš© ì—†ìŒ)" }}
            </div>
          </div>
          
        {% elif draft.mode == "draw" %}
          <!-- ê·¸ë¦¼: ì´ë¯¸ì§€ ì˜ì—­ (ì™„ì „ ë¶„ë¦¬) -->
          <div class="preview-section">
            <div class="preview-label">ğŸ¨ ì—…ë¡œë“œí•œ ê·¸ë¦¼</div>
            <div style="margin-top: 12px; text-align: center;">
              {% if draft.image_filename %}
                {% if draft.image_filename.startswith('dalle_') %}
                  {% set image_path = 'uploads/generated/' + draft.image_filename %}
                {% else %}
                  {% set image_path = 'uploads/user/' + draft.image_filename %}
                {% endif %}
                <img 
                  src="{{ url_for('static', filename=image_path) }}" 
                  alt="ì—…ë¡œë“œí•œ ê·¸ë¦¼"
                  style="max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
                  onerror="if(!this.dataset.fallback) { this.dataset.fallback='1'; this.src='{{ url_for('static', filename='uploads/' + draft.image_filename) }}'; } else { console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '{{ draft.image_filename }}'); this.style.display='none'; this.nextElementSibling.style.display='block'; }"
                >
                <div style="display: none; color: #E53E3E; padding: 20px; background: #FEF2F2; border-radius: 8px; margin-top: 12px;">
                  âš ï¸ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br>
                  <small style="color: #718096;">íŒŒì¼: {{ draft.image_filename }}</small>
                </div>
              {% else %}
                <div style="padding: 40px; background: #F7FAFC; border-radius: 12px; color: #718096; text-align: center;">
                  ğŸ“· ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì—†ìŒ<br>
                  <small>draft.image_filenameì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</small>
                </div>
              {% endif %}
            </div>
          </div>
          
          <!-- ê·¸ë¦¼: ì„¤ëª… ì˜ì—­ (ì™„ì „ ë¶„ë¦¬) -->
          <div class="preview-section">
            <div class="preview-label">ğŸ“ ê·¸ë¦¼ ì„¤ëª…</div>
            <div class="preview-content">
              {{ draft.draw_note or "(ê·¸ë¦¼ ì„¤ëª… ì—†ìŒ)" }}
            </div>
          </div>
          
        {% elif draft.mode == "music" %}
          <!-- ìŒì•…: í‚¤ì›Œë“œ -->
          <div class="preview-section">
            <div class="preview-label">ğŸµ ìŒì•… í‚¤ì›Œë“œ</div>
            <div class="preview-content">
              {{ draft.music_keywords or "(ìŒì•… í‚¤ì›Œë“œ ì—†ìŒ)" }}
            </div>
          </div>
        {% endif %}

        <!-- ì´ì „ AI ëŒ€í™” ë‚´ì—­ í‘œì‹œ -->
        {% if draft.ai_response and draft.ai_count > 0 %}
          <div class="preview-section" style="background: #F7FAFC;">
            <div class="preview-label" style="color: #667EEA; font-weight: 700;">ğŸ’¬ ì´ì „ AI ëŒ€í™”</div>
            <div class="preview-content" style="margin-top: 12px; padding: 16px; background: white; border-radius: 12px; font-size: 14px; line-height: 1.8; color: #4A5568; max-height: 200px; overflow-y: auto;">
              {{ draft.ai_response }}
            </div>
          </div>
        {% endif %}

        <!-- í†µí•© AI ì…ë ¥ì°½ -->
        <div id="ai-input-section" class="preview-section" style="display: none;">
          <label class="input-label" id="ai-input-label">ğŸ’¬ AIì—ê²Œ í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”</label>
          <textarea 
            name="user_input" 
            id="ai-input-textarea"
            placeholder="AIì—ê²Œ í•˜ê³  ì‹¶ì€ ë§ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”"
          ></textarea>
          <div id="ai-input-hint" style="display: none; font-size: 12px; color: #718096; margin-top: 8px;">
            ğŸ’¡ ì…ë ¥í•˜ë©´: DALL-Eê°€ ìƒˆ ì´ë¯¸ì§€ ìƒì„± | ë¹„ì›Œë‘ë©´: AIê°€ ì´ë¯¸ì§€ ë¶„ì„ ë° ì¡°ì–¸
          </div>
        </div>
      </div>

      <button type="submit" class="primary-button">ê³„ì†í•˜ê¸°</button>

      <script>
        // AI ì„ íƒì— ë”°ë¼ UI ë™ì  ë³€ê²½
        const aiSave = document.getElementById('ai-save');
        const aiChat = document.getElementById('ai-chat');
        const aiDevelop = document.getElementById('ai-develop');
        const interactionSection = document.getElementById('ai-interaction-section');
        const aiInputSection = document.getElementById('ai-input-section');
        const aiInputLabel = document.getElementById('ai-input-label');
        const aiInputTextarea = document.getElementById('ai-input-textarea');
        const aiInputHint = document.getElementById('ai-input-hint');
        
        const isDraw = {{ 'true' if draft.mode == 'draw' else 'false' }};

        function updateAiSection() {
          if (aiSave.checked) {
            // ê·¸ëŒ€ë¡œ ì €ì¥: ëª¨ë‘ ìˆ¨ê¹€
            interactionSection.style.display = 'none';
            aiInputSection.style.display = 'none';
          } else if (aiChat.checked) {
            // AIì™€ ëŒ€í™”
            interactionSection.style.display = 'block';
            aiInputSection.style.display = 'block';
            aiInputLabel.textContent = 'ğŸ’¬ ì´ ë‚´ìš©ê³¼ ê´€ë ¨í•´ì„œ AIì™€ ì–´ë–¤ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?';
            aiInputTextarea.placeholder = 'AIì—ê²Œ í•˜ê³  ì‹¶ì€ ë§ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”';
            aiInputHint.style.display = 'none';
          } else if (aiDevelop.checked) {
            // AIì™€ ë””ë²¨ë¡­
            interactionSection.style.display = 'block';
            aiInputSection.style.display = 'block';
            
            if (isDraw) {
              // ê·¸ë¦¼ ëª¨ë“œ: DALL-E
              aiInputLabel.textContent = 'ğŸ¨ ì´ë¯¸ì§€ë¥¼ ì–´ë–»ê²Œ ìˆ˜ì •í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?';
              aiInputTextarea.placeholder = 'ì˜ˆ: ë‚˜ë¹„ í•œë§ˆë¦¬ ì¶”ê°€, í•˜ëŠ˜ì„ ë” ë°ê²Œ, ë°°ê²½ì— ì‚° ì¶”ê°€ ë“±... (ì…ë ¥í•˜ë©´ DALL-Eê°€ ìƒˆ ì´ë¯¸ì§€ ìƒì„±)';
              aiInputHint.style.display = 'block';
            } else {
              // ê¸€ì“°ê¸°/ìŒì•… ëª¨ë“œ
              aiInputLabel.textContent = 'âœ¨ ì´ ë‚´ìš©ì„ AIì™€ í•¨ê»˜ ë” ë‹¤ë“¬ì–´ë³¼ê¹Œìš”?';
              aiInputTextarea.placeholder = 'ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ê³  ì‹¶ì€ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš” (ì„ íƒ)';
              aiInputHint.style.display = 'none';
            }
          }
        }

        aiSave.addEventListener('change', updateAiSection);
        aiChat.addEventListener('change', updateAiSection);
        aiDevelop.addEventListener('change', updateAiSection);

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        updateAiSection();
      </script>
    </form>

  {% elif step == 5.5 %}
    {% if draft.mode == "music" %}
      <!-- ìŒì•… ì¶”ì²œ í‘œì‹œ -->
      <h2>ğŸµ ìŒì•… ì¶”ì²œ</h2>
      
      <div class="music-recommendation-box">
        {% if draft.music_parsed %}
          <!-- ì¶”ì²œ ì´ìœ  -->
          {% if draft.music_parsed.reason %}
            <p class="music-reason">{{ draft.music_parsed.reason }}</p>
          {% endif %}
          
          <!-- ê³¡ ë¦¬ìŠ¤íŠ¸ -->
          {% if draft.music_parsed.songs %}
            <ul class="music-list">
              {% for song in draft.music_parsed.songs %}
                <li class="music-item">
                  <div class="music-info">
                    <span class="music-title">{{ song.display }}</span>
                  </div>
                  <a href="{{ song.youtube_url }}" target="_blank" class="youtube-link">
                    ğŸµ ë“¤ì–´ë³´ê¸°
                  </a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>{{ draft.ai_response }}</p>
          {% endif %}
        {% else %}
          <p>{{ draft.ai_response }}</p>
        {% endif %}
      </div>

    {% else %}
      <!-- ê¸€ì“°ê¸°/ê·¸ë¦¼ ëª¨ë“œ -->
      {% if draft.mode == "draw" %}
        <h2>ğŸ¨ AI ê²°ê³¼</h2>
      {% else %}
        <h2>ğŸ¤– AI ì‘ë‹µ</h2>
      {% endif %}
      
      <!-- DALL-Eë¡œ ìƒì„±ëœ ì´ë¯¸ì§€ í‘œì‹œ -->
      {% if draft.mode == "draw" and draft.image_filename %}
        <div style="margin-bottom: 24px; padding: 20px; background: white; border-radius: 16px; border: 2px solid #E2E8F0;">
          <div class="preview-label">âœ¨ ìƒì„±ëœ ì´ë¯¸ì§€</div>
          <div style="margin-top: 12px; text-align: center;">
            {% if draft.image_filename.startswith('dalle_') %}
              {% set image_path = 'uploads/generated/' + draft.image_filename %}
            {% else %}
              {% set image_path = 'uploads/user/' + draft.image_filename %}
            {% endif %}
            <img 
              src="{{ url_for('static', filename=image_path) }}" 
              alt="ìƒì„±ëœ ì´ë¯¸ì§€"
              style="max-width: 100%; max-height: 500px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.15);"
              onerror="if(!this.dataset.fallback) { this.dataset.fallback='1'; this.src='{{ url_for('static', filename='uploads/' + draft.image_filename) }}'; }"
            >
          </div>
        </div>
      {% endif %}
      
      <div class="ai-response-box">
        <p>{{ draft.ai_response }}</p>
      </div>
    {% endif %}

    <form method="POST">
      <button type="submit" class="primary-button">ë‹¤ìŒ</button>
    </form>

  {% elif step == 5.9 %}
    {% if draft.mode == "music" %}
      <!-- ìŒì•… ëª¨ë“œ ì „ìš© -->
      <h2>ğŸµ ìŒì•… ì¶”ì²œ</h2>
      <p class="hint">ì¶”ì²œë°›ì€ ìŒì•…ì´ ë§ˆìŒì— ë“œì…¨ë‚˜ìš”?</p>

      <form method="POST">
        <div class="next-action-grid music-mode">
          <label class="next-action-card {% if not can_use_ai_more %}disabled{% endif %}">
            <input type="radio" name="next_action" value="continue_ai" {% if can_use_ai_more %}checked{% endif %} {% if not can_use_ai_more %}disabled{% endif %} required>
            <div class="action-content">
              <div class="action-icon">ğŸ”„</div>
              <div class="action-title">ë‹¤ì‹œ ì¶”ì²œë°›ê¸°</div>
              <div class="action-desc">{% if can_use_ai_more %}ë‹¤ë¥¸ ìŒì•…ì„ ì¶”ì²œë°›ì•„ìš”{% else %}ì¶”ì²œ ì™„ë£Œ{% endif %}</div>
              <div class="action-badge {% if can_use_ai_more %}available{% else %}depleted{% endif %}">{{ ai_usage }}</div>
            </div>
          </label>

          <label class="next-action-card" {% if not can_use_ai_more %}checked{% endif %}>
            <input type="radio" name="next_action" value="save" {% if not can_use_ai_more %}checked{% endif %} required>
            <div class="action-content">
              <div class="action-icon">ğŸ’¾</div>
              <div class="action-title">ì €ì¥í•˜ê¸°</div>
              <div class="action-desc">ì´ ì¶”ì²œìœ¼ë¡œ ì €ì¥í• ê²Œìš”</div>
            </div>
          </label>
        </div>

        <button type="submit" class="primary-button">ì„ íƒ ì™„ë£Œ</button>
      </form>

    {% else %}
      <!-- ê¸€ì“°ê¸°/ê·¸ë¦¼ ëª¨ë“œ -->
      <h2>ğŸ’­ ë‹¤ìŒ í–‰ë™</h2>
      <p class="hint">ì§€ê¸ˆê¹Œì§€ í‘œí˜„í•œ ë‚´ìš©ì„ ì´ì–´ê°ˆê¹Œìš”, ì €ì¥í• ê¹Œìš”?</p>

      <!-- ì´ì „ AI ëŒ€í™” ë‚´ì—­ í‘œì‹œ -->
      {% if draft.ai_response %}
        <div class="preview-section" style="margin-bottom: 24px; background: #F7FAFC;">
          <div class="preview-label" style="color: #667EEA; font-weight: 700;">ğŸ’¬ ì´ì „ AI ëŒ€í™”</div>
          <div class="preview-content" style="margin-top: 12px; padding: 16px; background: white; border-radius: 12px; font-size: 14px; line-height: 1.8; color: #4A5568; max-height: 200px; overflow-y: auto;">
            {{ draft.ai_response }}
          </div>
        </div>
      {% endif %}

      <!-- DALL-Eë¡œ ìƒì„±ëœ ì´ë¯¸ì§€ í‘œì‹œ -->
      {% if draft.mode == "draw" and draft.image_filename %}
        <div style="margin-bottom: 24px; padding: 20px; background: white; border-radius: 16px; border: 2px solid #E2E8F0;">
          <div class="preview-label">âœ¨ í˜„ì¬ ì´ë¯¸ì§€</div>
          <div style="margin-top: 12px; text-align: center;">
            {% if draft.image_filename.startswith('dalle_') %}
              {% set image_path = 'uploads/generated/' + draft.image_filename %}
            {% else %}
              {% set image_path = 'uploads/user/' + draft.image_filename %}
            {% endif %}
            <img 
              src="{{ url_for('static', filename=image_path) }}" 
              alt="í˜„ì¬ ì´ë¯¸ì§€"
              style="max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.15);"
              onerror="if(!this.dataset.fallback) { this.dataset.fallback='1'; this.src='{{ url_for('static', filename='uploads/' + draft.image_filename) }}'; }"
            >
          </div>
        </div>
      {% endif %}

      <form method="POST">
        <div class="next-action-grid">
          <label class="next-action-card">
            <input type="radio" name="next_action" value="continue_expression" checked required>
            <div class="action-content">
              <div class="action-icon">âœï¸</div>
              <div class="action-title">í‘œí˜„ ë” ì‘ì„±í•˜ê¸°</div>
              <div class="action-desc">ê¸€/ê·¸ë¦¼/ìŒì•…ì„ ê³„ì† í‘œí˜„í•´ìš”</div>
              <div class="action-badge unlimited">ë¬´ì œí•œ</div>
            </div>
          </label>

          <label class="next-action-card {% if not can_use_ai_more %}disabled{% endif %}">
            <input type="radio" name="next_action" value="continue_ai" {% if not can_use_ai_more %}disabled{% endif %} required>
            <div class="action-content">
              <div class="action-icon">ğŸ¤–</div>
              <div class="action-title">AIì™€ ë” ëŒ€í™”í•˜ê¸°</div>
              <div class="action-desc">{% if can_use_ai_more %}í‘œí˜„ì„ ë” í’€ì–´ë´ìš”{% else %}ì‚¬ìš© ì™„ë£Œ{% endif %}</div>
              <div class="action-badge {% if can_use_ai_more %}available{% else %}depleted{% endif %}">{{ ai_usage }}</div>
            </div>
          </label>

          <label class="next-action-card">
            <input type="radio" name="next_action" value="save" required>
            <div class="action-content">
              <div class="action-icon">ğŸ’¾</div>
              <div class="action-title">ì €ì¥í•˜ê¸°</div>
              <div class="action-desc">ì§€ê¸ˆê¹Œì§€ í‘œí˜„í•œ ë‚´ìš©ì„ ì €ì¥í•´ìš”</div>
            </div>
          </label>
        </div>

        <button type="submit" class="primary-button">ì„ íƒ ì™„ë£Œ</button>
      </form>
    {% endif %}

  {% elif step == 6 %}
    <h2>ê°ì •ì˜ ë³€í™”</h2>
    <p class="hint">í‘œí˜„ í™œë™ì„ í†µí•´ ê°ì •ì´ ì–´ë–»ê²Œ ë³€í–ˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”</p>

    <!-- ìƒ‰ ë³€í™” ë¹„êµ -->
    <div class="color-comparison">
      <div class="color-comparison-item">
        <div class="color-label">ì²˜ìŒ ê°ì •</div>
        <div class="color-orb-display" style="background: {{ initial_color_hex }};">
          <div class="orb-inner"></div>
        </div>
        <div class="color-name">{{ mood_name }}</div>
      </div>

      <div class="color-arrow">â†’</div>

      <div class="color-comparison-item">
        <div class="color-label">í™œë™ í›„ ê°ì •</div>
        <div class="color-orb-display" style="background: {{ final_color_hex }};">
          <div class="orb-inner"></div>
        </div>
        <div class="color-intensity">{{ "%.0f"|format(intensity * 100) }}% ì˜…ì–´ì§</div>
      </div>
    </div>

    <div class="color-explanation">
      <p>
        {% if intensity > 0.5 %}
          ê°ì •ì´ ë§ì´ í•´ì†Œëœ ê²ƒ ê°™ì•„ìš”. âœ¨
        {% elif intensity > 0.2 %}
          ê°ì •ì´ ì¡°ê¸ˆ ì •ë¦¬ë˜ê³  ìˆì–´ìš”. ğŸŒ±
        {% else %}
          ì•„ì§ ê°ì •ì´ ì§„í•˜ê²Œ ë‚¨ì•„ìˆë„¤ìš”.
        {% endif %}
      </p>
    </div>

    <form method="POST">
      <h3 style="margin-top: 32px; margin-bottom: 16px; text-align: center; color: #2D3748;">ì§€ê¸ˆ ê°ì •ì˜ ì§„í•˜ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
      <p class="hint" style="margin-bottom: 24px;">ìœ„ì˜ "í™œë™ í›„ ê°ì •"ì„ ì°¸ê³ í•˜ë˜, ë³¸ì¸ì´ ëŠë¼ëŠ” {{ mood_name }}ì˜ ì§„í•˜ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”.<br>ì™¼ìª½ì¼ìˆ˜ë¡ ì§„í•˜ê³ , ì˜¤ë¥¸ìª½ì¼ìˆ˜ë¡ ì˜…ì–´ì§‘ë‹ˆë‹¤.</p>
      
      <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-bottom: 32px;">
        {% for color_data in intensity_colors %}
          <label style="cursor: pointer; text-align: center;">
            <input 
              type="radio" 
              name="intensity_level" 
              value="{{ color_data.level }}" 
              {% if loop.index == 3 %}checked{% endif %}
              required
              style="display: none;"
            >
            <div style="
              width: 80px;
              height: 80px;
              border-radius: 50%;
              background: {{ color_data.color_hex }};
              border: 3px solid #E2E8F0;
              box-shadow: 0 4px 12px rgba(0,0,0,0.1);
              transition: all 0.3s ease;
              position: relative;
            " class="intensity-orb">
              <div style="
                position: absolute;
                bottom: -28px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 12px;
                font-weight: 600;
                color: #4A5568;
                white-space: nowrap;
              ">{{ color_data.percentage }}%</div>
            </div>
          </label>
        {% endfor %}
      </div>

      <style>
        input[type="radio"]:checked + .intensity-orb {
          border-color: #667EEA !important;
          box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4) !important;
          transform: scale(1.1);
        }
        .intensity-orb:hover {
          border-color: #667EEA;
          transform: scale(1.05);
        }
      </style>

      <button type="submit" class="primary-button" style="margin-top: 48px;">ì €ì¥í•˜ê¸°</button>
    </form>

  {% elif step == 7 %}
    <h2>âœ¨ ì˜¤ëŠ˜ì˜ ê¸°ë¡ ì™„ì„±</h2>
    <p class="hint">ê°ì •ì´ ê¸°ë¡ë˜ì—ˆì–´ìš”. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.</p>

    <div class="completion-message">
      <div class="completion-icon">ğŸŒ™</div>
      <p>ì˜¤ëŠ˜ì˜ ê°ì •ì´ ìº˜ë¦°ë”ì— ì €ì¥ë˜ì—ˆì–´ìš”.</p>
      
      {% if closing_message %}
        <div style="margin-top: 24px; padding: 20px; background: rgba(255, 255, 255, 0.5); border-radius: 16px; border: 1px solid #E2E8F0;">
          <div style="font-size: 13px; color: #718096; margin-bottom: 8px; font-weight: 600;">ğŸ’¬ ë§ˆë¬´ë¦¬ í•œë§ˆë””</div>
          <p style="color: #2D3748; line-height: 1.6; margin: 0;">{{ closing_message }}</p>
        </div>
      {% endif %}
    </div>

    <form method="POST">
      <button type="submit" class="primary-button">ì™„ë£Œ</button>
    </form>

  {% else %}
    <div class="page-head">
      <div>
        <h2 class="page-title">ğŸŒ™ ë‚˜ì˜ ê°ì • ë¡œê·¸</h2>
        {% if saved %}
          <p class="hint">âœ… ì €ì¥ë˜ì—ˆì–´ìš”.</p>
        {% else %}
          <p class="hint">ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ìŒ“ì´ëŠ” ê³³ì´ì—ìš”.</p>
        {% endif %}
      </div>

      <div class="page-actions">
        <a href="{{ url_for('step1') }}">
          <button type="button" class="primary-button" style="font-size: 18px; padding: 16px 48px;">ìƒˆ ê¸°ë¡í•˜ê¸°</button>
        </a>
        
        <div class="view-links" style="margin-top: 16px; display: flex; gap: 12px; align-items: center;">
          <a href="{{ url_for('history', n=5) }}" style="color: #667EEA; font-weight: 600;">ìµœê·¼ 5ê°œ</a>
          <a href="{{ url_for('history', n=10) }}" style="color: #667EEA; font-weight: 600;">ìµœê·¼ 10ê°œ</a>
          <span style="color: #CBD5E0;">|</span>
          <a href="{{ url_for('calendar_view') }}" style="color: #667EEA; font-weight: 600;">ğŸ“… ìº˜ë¦°ë”</a>
        </div>
      </div>
    </div>

    {% if records and records|length > 0 %}
      {% for r in records %}

        {# --- mode ì•„ì´ì½˜ ê²°ì • (STEP5-1) --- #}
        {% set mode_icon = "" %}
        {% if r.mode == "write" %}{% set mode_icon = "âœï¸" %}{% endif %}
        {% if r.mode == "draw" %}{% set mode_icon = "ğŸ¨" %}{% endif %}
        {% if r.mode == "music" %}{% set mode_icon = "ğŸµ" %}{% endif %}

        <article class="record-card">
          <!-- ì¹´ë“œ í—¤ë”: ë‚ ì§œ/ì•„ì´ì½˜/ìƒ‰ -->
          <header class="record-head">
            <div class="record-meta">
              <span class="record-icon" aria-label="mode">{{ mode_icon }}</span>
              <span class="record-time">{{ r.date_time }}</span>
            </div>
            <div class="record-tags">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: {{ r.final_color or r.mood_color }}; border: 2px solid #E2E8F0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
            </div>
          </header>

          <!-- ì¹´ë“œ íƒ€ì´í‹€: ê°ì • í•œ ì¤„ -->
          <h3 class="record-title">{{ r.mood_text }}</h3>

          <!-- ì¹´ë“œ ë³¸ë¬¸: ëª¨ë“œë³„ ë‚´ìš© -->
          <section class="record-body">

            {% if r.text_content %}
              <div class="record-block">
                <div class="block-title">âœï¸ ê¸€</div>
                <div class="block-content">{{ r.text_content }}</div>
              </div>
            {% endif %}

            {% if r.draw_note %}
              <div class="record-block">
                <div class="block-title">ğŸ¨ ê·¸ë¦¼ ë©”ëª¨</div>
                <div class="block-content">{{ r.draw_note }}</div>
              </div>
            {% endif %}

            {% if r.music_keywords %}
              <div class="record-block">
                <div class="block-title">ğŸµ ìŒì•… í‚¤ì›Œë“œ</div>
                <div class="block-content">{{ r.music_keywords }}</div>
              </div>
            {% endif %}

            {% if r.ai_response %}
              <div class="record-block ai-block">
                <div class="block-title">ğŸ¤– AI ì‘ë‹µ</div>
                <div class="block-content">{{ r.ai_response }}</div>
              </div>
            {% endif %}

            {% if r.background %}
              <div class="record-block subtle">
                <div class="block-title">ğŸ§© ë§¥ë½</div>
                <div class="block-content">{{ r.background }}</div>
              </div>
            {% endif %}

            {% if r.image_filename %}
              <figure class="record-media">
                {% if r.image_filename.startswith('dalle_') %}
                  {% set image_path = 'uploads/generated/' + r.image_filename %}
                {% else %}
                  {% set image_path = 'uploads/user/' + r.image_filename %}
                {% endif %}
                <img
                  src="{{ url_for('static', filename=image_path) }}"
                  alt="uploaded image"
                  onerror="if(!this.dataset.fallback) { this.dataset.fallback='1'; this.src='{{ url_for('static', filename='uploads/' + r.image_filename) }}'; }"
                >
              </figure>
            {% endif %}

          </section>
        </article>

      {% endfor %}
    {% else %}
      <div class="empty-state">
        <p class="hint">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.</p>
        <a href="{{ url_for('step1') }}">
          <button type="button" class="primary-button">ì²« ê¸°ë¡ ì‹œì‘í•˜ê¸°</button>
        </a>
      </div>
    {% endif %}

  {% endif %}

</div>
</body>
</html>
